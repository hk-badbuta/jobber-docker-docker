# jobber-docker-docker
This project extends the jobber docker image (https://hub.docker.com/_/jobber) and enable Docker-in-Docker feature, as well as including the common system adminstration software

# Background
I have been looking for the job scheduler running in docker environment and the job can control other docker container like stop/stop/exec.  I found a great project: [blackbelops/jobber-docker](https://github.com/blacklabelops-legacy/jobber-cron/tree/master/jobber-docker) but it was not updated for several years.

Therefore I start this project based on blackbelops/jobber-docker and additing more software packages I needed.

# About docker-in-docker
By studying many docker-in-docker projects I noted that the key concept is to bind the docker host's unix socket to the container and it works.

# Software included

The following are the software/based image installed/used in this project:

- Base Image = [Jobber-docker 1.4.3 (Alpine 3.11)](https://hub.docker.com/layers/jobber/library/jobber/1.4.3-alpine3.11/images/sha256-fa7b08aecd2d749e32dc9d0785367d44fcc88ec83418329b3dc697e218aca5ae)
- Docker 19.03.11
- Docker Compose 1.26.0
- Docker Machine 0.16.2
- wget
- curl
- Python 2 (latest)
- pip
- Bash
- Expect
- jq
- rsync
- git
- SSH Client (including scp)

# Build the image

```bash
docker build --rm -t jobber-docker-docker:latest .
```

# Run as a daemon and mount local docker engine

In order to use Docker inside the container and connect to the host's docker engine, we have to bind the unix socket.  To do this, run the following command to start the docker container (daemon):

```bash
$ docker run -d --rm  \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  --name jobber-docker \
  jobber-docker-docker
```

# Timezone

The default timezone is set to `Asia/Hong_Kong`.  You may specify the timezone in docker enviroment variable.  For example:

```bash
$ docker run -d --rm  \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -e TZ=Asia/Hong_Kong
  --name jobber-docker \
  jobber-docker-docker
```

# Jobber Work folder and Jobber file (.jobber)
The jobber working folder is `/jobber-work` and the corresponding environment variable is `JOBBER_WORK_HOME`.

The sample jobber file (based on the file generated by: `jobber init`) is copied to the working folder (`$JOBBER_WORK_HOME`) and linked from a symbolic link `$JOBBER_WORK_HOME/.jobber`.

Be noted that default jobber file location is `$JOBBER_WORK_HOME/.jobber`.  You may mount the Jobber Work folder or a jobber file if needed.

Be reminded to reload the job by `jobber reload`.

# Job declaration in container environment variable

Reffering the `blackbelops/jobber-docker`, it supports the job declaration via container environment variables.  However, like [jobber docker image](https://hub.docker.com/_/jobber), this project has __not__ supported yet.

# Docker user
Unlike Offical [Jobber docker](https://hub.docker.com/_/jobber) image, the jobber runner (daemon) process is running as root, not `jobberuser`.

# Examples

## Schedule a job to control the target (slibing) container with docker

__NOTE:__  Whatever the docker host is standalone or a node under docker swarm, the target container must be under the same docker host/node (i.e. next to the jobber-docker-docker container)

### Assumptions

1. The target container is named `testhello` and stopped
1. Docker host's unix socket is binded
1. The jobber containter will be/is run at the same host.

### Start the target container

```bash
$ docker run --name testhello centos bash -c "echo HelloWorld"
```

### Start the jobber container as daemon

```bash
$ docker run -d --rm  \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  --name jobber-docker \
  jobber-docker-docker
```

### Enter the shell in jobber container

```bash
$ docker exec -it jobber-docker bash
```

Add the new job by appending the following lines in `.jobber` file.  Be noted the tab/space because the YAML format.

```
  TestHelloContainer:
    cmd: docker start testhello
    time:'*/5 * * * * *'

```

Reload the jobber jobs:
```bash
$ jobber reload
```

### Check the result

In the docker host (or the shell in jobber container)

```bash
$ docker logs testhello
HelloWorld
HelloWorld
HelloWorld
HelloWorld
HelloWorld
HelloWorld
HelloWorld
HelloWorld
HelloWorld
...
```

# About docker-entrypoint.d

Regarding the common practice of making docker image for `docker-entrypoint`, you may add additional entrypoint script (`.sh`) inside folder `/docker-entrypoint.d`, where the scripts will be loaded by `/docker-entrypoint.sh`.  You may also control the loading sequence by the script filename.  For example, `01-runme.sh` will be run before `02-runnext.sh`.

__NOTE:__ The script for jobber runner/daemon will be executed at the last.

# About Bash's profile/rc

Since docker will not load the `/etc/profile`, the `.bashrc` have been added  to the user home directory (i.e. `/root`).  The `.bashrc` script in this image will run the script (.sh) inside `/etc/profile.d/`.

In addition, The `.bashrc` script will check and load `/root/.bash_aliases` if it exists.

# Reference

- [Jobber](https://dshearer.github.io/jobber/)
    - [How to Use, v1.4](https://dshearer.github.io/jobber/doc/v1.4/)
- [Dockerized Jobber Cron](https://github.com/blacklabelops-legacy/jobber-cron)
- [Dockerized Jobber Cron - Docker: Dockerfile](https://github.com/blacklabelops-legacy/jobber-cron/blob/master/jobber-docker/Dockerfile)